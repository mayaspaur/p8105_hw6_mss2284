---
title: "p8105_hw6_mss2284"
author: "Maya Spaur"
date: "11/16/2019"
output: github_document
---

```{r setup}
library(tidyverse)
library(modelr)
library(mgcv)
library(ggplot2)

```

#Problem 1

Load and tidy data: categorical variabels were converted into factor variables, and variables that had units in pounds (delwt, ppwt, wtgain) were converted to grams.

```{r}
data = 
  read_csv(file = "./data/birthweight.csv") %>%
  janitor::clean_names() %>%
  mutate(
    babysex = as.factor(babysex),
    frace = as.factor(frace),
    mrace = as.factor(mrace),
    delwt = 453.592*delwt,
    ppwt = 453.592*ppwt,
    wtgain = 453.592*wtgain
  )

```

In proposing a regression model for birthweight, I explore two different model-building processes. The first uses a data-driven model-building process, and the second uses a hypothesized structure and cross-validation.

Modeling process: hypothesis testing

Model 1. This process is data-driven and is based on the variables that are statistically significant.


```{r modeling process}
model = lm(bwt ~ babysex + bhead + blength + delwt + fincome + frace + gaweeks + malform + menarche + mheight + momage + mrace + parity + pnumlbw + pnumsga + ppbmi + ppwt + smoken + wtgain, data = data)

model %>%
  broom::tidy() %>%
  knitr::kable(digits = 2)
```

Using this model-building process, the following variables were statistically significant (p < 0.05) and would be included in the proposed model:

babysex2, bhead, blength, delwt, gaweeks, mrace2, parity, and smoken.

Plot of model residuals against fitted values:

```{r}

proposed_model = lm(bwt ~ babysex+ bhead + blength + delwt + gaweeks+ mrace + parity + smoken, data = data)

scatter_plot =
  data %>% 
  modelr::add_residuals(proposed_model) %>% 
  modelr::add_predictions(proposed_model) %>%
  ggplot(aes(x = pred, y = resid)) + geom_point()

scatter_plot
```

To assess the predictive ability of this model, a cross-validation modeling process was also used, using a model based on the terms that were found statistically significant in the proposed model: babysex2, bhead, blength, delwt, gaweeks, mrace2, parity, and smoken


I propose to include these statistically significant variables in the model.


```{r cross validation, message = FALSE}

cv_df =
  crossv_mc(data, 100)

cv_df %>% pull(train) %>% .[[1]] %>% as_tibble
cv_df %>% pull(test) %>% .[[1]] %>% as_tibble

cv_df =
  cv_df %>% 
  mutate(
    train = map(train, as_tibble),
    test = map(test, as_tibble))

cv_df = 
  cv_df %>% 
  mutate(linear_mod  = map(train, ~lm(bwt ~ babysex+bhead+blength+ delwt+ gaweeks+ mrace + parity + smoken, data = .x))) %>% 
  mutate(rmse_linear = map2_dbl(linear_mod, test, ~rmse(model = .x, data = .y))) 
```

Plot of the distribution of RMSE values

```{r}
plot2 = 
  cv_df %>% 
  select(starts_with("rmse")) %>% 
  pivot_longer(
    everything(),
    names_to = "model", 
    values_to = "rmse",
    names_prefix = "rmse_") %>% 
  mutate(model = fct_inorder(model)) %>% 
  ggplot(aes(x = model, y = rmse)) + geom_violin()

plot2
```

Given the distribution of RMSE values, this corresponds to the RMSE for the proposed linear model above, with `r rmse(model, data)`. However, these values are still high so the model is not expected to be highly predictive of other observations.


#Make one plot per model

Main Effects Model

```{r main effects model}

main_effects = lm(bwt ~ blength + gaweeks, data = data)

main_effects %>%
  broom::tidy()

plot_main_effects =
  data %>% 
  modelr::add_residuals(main_effects) %>%
  modelr::add_predictions(main_effects) %>%
  ggplot(aes(x = pred, y = resid)) + geom_point()

plot_main_effects
```

#r generates interaction terms for everything when doing these types of models, so JUST look at the p value for the interaction term to assess if it's statistically significant!

```{r interaction model}

interaction_effects = lm(bwt ~ blength + gaweeks + (bhead*blength*babysex), data = data)

interaction_effects %>%
  broom::tidy()

plot_interaction_effects =
  data %>% 
  modelr::add_residuals(interaction_effects) %>%
  modelr::add_predictions(interaction_effects) %>%
  ggplot(aes(x = pred, y = resid)) + geom_point()

plot_interaction_effects
```

For the model containing babysex, bhead, blength, and the interactions between these variables, the interaction terms were statistically significant.


Compare models

#Error in seq_len(n) : argument must be coercible to non-negative integer

r comparing models
cv_bwt_df =
  crossv_mc(data, 100) %>%
  mutate(
    train = map(train, as_tibble),
    test = map(test, as_tibble))

cv_bwt_df = 
  cv_bwt_df %>% 
  mutate(proposed_model  = map(train, ~lm(bwt ~ babysex+ bhead + blength + delwt + gaweeks+ mrace + parity + smoken, data = .x)),
         main_effects    = map(train, ~lm(bwt ~ blength + gaweeks, data = .x)),
         interaction_effects  = map(train, ~lm(bwt ~ blength + gaweeks + (bhead*blength*babysex), data = .x))) %>% 
  mutate(rmse_proposed = map2_dbl(proposed_model, test, ~rmse(model = .x, data = .y)),
         rmse_main_effects    = map2_dbl(main_effects, test, ~rmse(model = .x, data = .y)),
         rmse_interaction_effects = map2_dbl(interaction_effects, test, ~rmse(model = .x, data = .y)))




#Error? How to adjust broom::tidy --> gives estimates for beta0 and beta1, can compute the log(beta0 and beta1 by creating a new column). have to pivot the estimate wider
#get CI by taking the percentiles

#Problem 2

r, echo = FALSE
weather_df = 
  rnoaa::meteo_pull_monitors(
    c("USW00094728"),
    var = c("PRCP", "TMIN", "TMAX"), 
    date_min = "2017-01-01",
    date_max = "2017-12-31") %>%
  mutate(
    name = recode(id, USW00094728 = "CentralPark_NY"),
    tmin = tmin / 10,
    tmax = tmax / 10) %>%
  select(name, id, everything())
```

Bootstraps

r
set.seed(1)

boot_straps = 
  weather_df %>% 
  modelr::bootstrap(n = 5000) %>%
  mutate(models = map(strap, ~lm(tmax ~ tmin, data = .x)),
         results = map(models, broom::glance()),
         reults_2 = map(models, broom::tidy())) %>%
  select(-strap, -models) %>%
  unnest(results) %>%
  group_by(term) %>%
  summarize(r_squared = coef(estimate))


